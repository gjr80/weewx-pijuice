PiJuice Service

Description

The PiJuice service is a WeeWX service that supports the PiJuice
Uninterruptible Power Supply (UPS) Hardware Attached on Top (HAT). The PiJuice
service augments WeeWX loop packets from an existing driver with data obtained
from the PiJuice via the PiJuice developer provided PiJuice API. Once added to
the WeeWX loop packets the PiJucie data can be saved to the WeeWX database and
used in WeeWX generated reports and plots.

Pre-Requisites

The PiJuice service requires WeeWX v4.0.0 operating under Python 3 only.

Installation Instructions

Note: Symbolic names are used below to refer to file locations on the WeeWX
      system. Symbolic names allow a common name to be used to refer to a
      directory that may be different from system to system. The following
      symbolic name is used below:

    BIN_ROOT. The path to the directory where WeeWX executables are located.
    This directory varies depending on WeeWX installation method. Refer to
    http://weewx.com/docs/usersguide.htm#Where_to_find_things in the WeeWX
    User's Guide for further information.

1.  Download the PiJuice service extension package:

    $ wget -P /var/tmp https://github.com/gjr80/weewx-pijuice/releases/download/v0.1.0/pj-0.1.0.tar.gz

2.  If installing using the WeeWX wee_extension utility:

    -   install the PiJuice service extension:

        $ wee_extension --install=/var/tmp/gw1000-0.4.0.tar.gz
            
        Note: Depending on your system/installation the above command may need
              to be prefixed with sudo.

        Note: Depending on your WeeWX installation wee_extension may need to be
              prefixed with the path to wee_extension.

    -   skip to step 4

3.  If installing manually:

    -   extract the contents of the PiJuice service extension package:
    
        $ tar -xzf /var/tmp/pj-0.1.0.tar.gz -C /var/tmp
     
    -   copy the file juice.py to the $BIN_ROOT/user directory:
    
        $ cp /var/tmp/pj/bin/user/juice.py $BIN_ROOT/user

        Note: Depending on your system/installation the above command may need
              to be prefixed with sudo.

    -   add the following stanza to weewx.conf:

        [PiJuice]
            # This section is for the PiJuice service.

            # Interval in seconds between PiJuice updates, default is 20 seconds
            update_interval = 20

    -   add PiJuiceService to the data_services option under the [Engine]
        [[Services]] stanza in weewx.conf. It should look something like:

        [Engine]
            [[Services]]
                ...
                data_services = user.juice.PiJuiceService

        Note: There may be other entries included at the data_services option,
              multiple entries should be separated by a comma,
              eg: data_services = user.file1.service1, user.file2.service2

4.  Test the PiJuice service by running the service file directly using the
--test-service command line option:

    $ PYTHONPATH=/home/weewx/bin python -m user.juice --test-service

    for setup.py installs or for package installs use:

    $ PYTHONPATH=/usr/share/weewx python -m user.juice --test-service

    Note: Depending on your system/installation the above command may need
              to be prefixed with sudo.

    Note: Whilst the service may be run independently of WeeWX the service
          still requires WeeWX and it's dependencies be installed. As the
          PiJuice API software only runs under Python 3 the WeeWX Python 3
          dependencies must be installed and the service must be run under
          Python 3. This may be different to the Python version invoked by the
          command 'python'. This means that on some systems 'python' in the
          above commands may need to be changed to 'python3'.

    Note: If necessary you can specify the PiJuice bus and port using the
          --bus and --port command line options. Refer to the PiJuice service
          help using --help for further information.

    You should observe loop packets being emitted on a regular basis. Once
    finished press ctrl-c to exit.

    Note: You will only see loop packets and not archive records when running
          the service directly. This is because you are seeing output directly
          from the driver and not WeeWX.

5.  You may choose to run WeeWX directly (refer http://weewx.com/docs/usersguide.htm#Running_directly)
to observe the loop packets and archive records being generated by WeeWX. Note
that depending on the frequency of the loop packets emitted by the in-use
driver and the update interval of the PiJuice service not all loop packets may
include piJuice data; however, provided that the PiJuice update interval is
less than the frequency of the loop packets emitted by the in-use driver each
archive record should contain PiJuice data.

6.  Once satisfied that the PiJuice service is operating correctly you can
restart the WeeWX daemon:

    $ sudo /etc/init.d/weewx restart
        
    or

    $ sudo service weewx restart

    or

    $ sudo systemctl restart weewx

7.  You may wish to refer to the piJuice service wiki(https://github.com/gjr80/weewx-pijuice/wiki)
for further guidance on customising the operation of the PiJuice service,
including enabling the PiJuice archive service to store PiJuice data in a
separate database and integrating PiJuice data into WeeWX generated reports.


Upgrade Instructions

To upgrade from an earlier version of the PiJuice service simply install the
PiJuice service version you wish to upgrade to as per the Installation
Instructions above.

Note: The Installation Instructions refer to the current release only. It is
      recommended that users upgrade to the latest release rather than an
      earlier release.

Downgrade Instructions

To downgrade to an earlier release first uninstall the currently installed
PiJuice service and then install the desired release as per the Installation
Instructions above.

Note: Care should be taken when downgrading to an earlier release as subsequent
      releases may have entailed enduring changes; for example database schema
      changes, that are not undone by simply uninstalling the PiJuice service.
